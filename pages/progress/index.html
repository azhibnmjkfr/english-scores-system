<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Progress - MTsT Daarut Tahfizh Al-Ikhlas</title>
  <meta name="description" content="Class Progress Analysis - English Language">
  <meta name="author" content="Ahmad Zaman Huri, S.Pd.">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      /* Colors */
      --primary:#234626; --primary-dark:#1A351D; --accent-gold:#D4AF37;
      --neutral-white:#FFFFFF; --neutral-light:#F9FAFB; --neutral-gray:#E5E7EB; --neutral-dark:#374151;
      --success:#16A34A; --warning:#F59E0B; --danger:#DC2626; --needs-improvement:#F97316; --waiting:#6B7280;
      --footer-bg:linear-gradient(135deg,#1A351D 0%,#234626 100%); --highlight-bg:rgba(212,175,55,.05);

      /* Type */
      --font-family:'Inter',system-ui,sans-serif;
      --font-size-xs:.75rem; --font-size-sm:.875rem; --font-size-base:1rem; --font-size-lg:1.0625rem; --font-size-xl:1.25rem; --font-size-2xl:1.35rem;

      /* Spacing (padat) */
      --space-1:.25rem; --space-2:.5rem; --space-3:.65rem; --space-4:.85rem; --space-6:1.1rem;

      /* Radius & shadows */
      --radius-sm:.35rem; --radius-md:.5rem; --radius-lg:1rem;
      --shadow-sm:0 1px 2px rgba(0,0,0,.04); --shadow-md:0 2px 6px rgba(0,0,0,.08); --shadow-badge:0 1px 2px rgba(0,0,0,.1); --shadow-footer:0 2px 8px rgba(35,70,38,.2);

      --transition:all .2s ease;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-family);background:var(--neutral-light);color:var(--neutral-dark);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:0 auto;padding:var(--space-2) var(--space-3)}

    /* Header */
    .header{background:var(--primary);color:#fff;padding:var(--space-4);text-align:center;border-bottom:3px solid var(--accent-gold);border-radius:0 0 var(--radius-md) var(--radius-md)}
    .header .back-nav{text-align:left;margin-bottom:var(--space-2)}
    .header .back-btn{display:inline-flex;align-items:center;gap:var(--space-2);color:#fff;text-decoration:none;font-weight:600;font-size:var(--font-size-xs);padding:var(--space-1) var(--space-2);border-radius:var(--radius-sm);background:var(--primary-dark);box-shadow:var(--shadow-sm);border:1px solid rgba(255,255,255,.1)}
    .header .back-btn:hover{background:var(--accent-gold);color:var(--primary)}
    .title{display:flex;align-items:center;justify-content:center;gap:var(--space-2)}
    .title i{font-size:var(--font-size-xl)}
    .header h1{font-size:var(--font-size-2xl);font-weight:700}
    .header .info{font-size:var(--font-size-xs);opacity:.95;max-width:700px;margin:var(--space-2) auto 0}
    .header .info span{display:inline-block;margin:0 var(--space-2)}

    /* Stats */
    .stats-section{padding:var(--space-3) 0}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:var(--space-3)}
    .stat-card{background:#fff;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);padding:var(--space-3);display:flex;align-items:center;gap:var(--space-2);transition:var(--transition);border:1px solid #F1F5F9}
    .stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
    .stat-icon{width:36px;height:36px;background:var(--primary);border-radius:.5rem;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.95rem}
    .stat-content .stat-number{font-size:var(--font-size-lg);font-weight:700;color:var(--primary)}
    .stat-content .stat-label{font-size:var(--font-size-xs);opacity:.9}

    /* Table */
    .data-section{padding:var(--space-2) 0;overflow-x:auto}
    .table-container{background:#fff;border-radius:var(--radius-md);box-shadow:var(--shadow-md);overflow:hidden;border:1px solid #EEF2F7}
    table{width:100%;border-collapse:collapse;min-width:1000px}
    thead{background:var(--primary);color:#fff;position:sticky;top:0;z-index:1}
    th{padding:var(--space-3);font-weight:700;font-size:var(--font-size-sm);text-align:left;border-bottom:1px solid rgba(255,255,255,.2)}
    td{padding:var(--space-3);border-bottom:1px solid var(--neutral-gray);font-size:var(--font-size-sm)}
    tbody tr:hover{background:var(--highlight-bg);transition:var(--transition)}

    /* Footer Row */
    tbody tr.total-row{background:var(--footer-bg);color:#fff;font-weight:700;box-shadow:var(--shadow-footer);border-top:4px solid var(--accent-gold)}
    tbody tr.total-row td{padding:var(--space-3);border-bottom:none}

    /* Badges */
    .status-badge{padding:var(--space-2) var(--space-3);border-radius:var(--radius-lg);font-size:var(--font-size-sm);font-weight:600;display:inline-block;text-align:center;box-shadow:var(--shadow-badge);border:1px solid}
    .status-excellent{background:var(--success);color:#fff;border-color:#14532D}
    .status-good{background:var(--warning);color:#fff;border-color:#D97706}
    .status-needs-improvement{background:var(--needs-improvement);color:#fff;border-color:#EA580C}
    .status-critical{background:var(--danger);color:#fff;border-color:#B91C1C}
    .status-waiting{background:var(--waiting);color:#fff;border-color:#4B5563}

    .avg-badge{padding:var(--space-1) var(--space-2);border-radius:var(--radius-lg);font-size:var(--font-size-xs);font-weight:600;display:inline-block;text-align:center;box-shadow:var(--shadow-badge);border:1px solid}
    .avg-excellent{background:var(--success);color:#fff;border-color:#14532D}
    .avg-good{background:var(--warning);color:#fff;border-color:#D97706}
    .avg-standard{background:var(--needs-improvement);color:#fff;border-color:#EA580C}
    .avg-warning{background:var(--danger);color:#fff;border-color:#B91C1C}
    .avg-no-data{background:var(--waiting);color:#fff;border-color:#4B5563}

    .class-badge{padding:var(--space-1) var(--space-2);border-radius:var(--radius-lg);font-size:var(--font-size-xs);font-weight:600;display:inline-block;text-align:center;box-shadow:var(--shadow-badge);background:var(--primary-dark);color:#fff;border:1px solid #0D1F11}
    .total-row .class-badge{background:var(--accent-gold);color:var(--primary-dark);border-color:#B8972F}

    /* States */
    .loading-cell{text-align:center;padding:var(--space-6);color:var(--neutral-dark)}
    .loading-spinner{width:22px;height:22px;border:3px solid var(--neutral-gray);border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto var(--space-2)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-cell{text-align:center;padding:var(--space-6);color:var(--danger)}
    .error-cell i{font-size:var(--font-size-base);margin-bottom:var(--space-2);display:block}
    .no-data{text-align:center;padding:var(--space-6);color:var(--neutral-dark)}

    /* Footer */
    .footer{background:var(--primary-dark);color:#fff;text-align:center;padding:var(--space-3);margin-top:var(--space-3);border-radius:var(--radius-md);box-shadow:var(--shadow-sm);font-size:var(--font-size-xs)}
    .footer .brand{font-size:var(--font-size-sm);font-weight:700}
    .footer .info{opacity:.9;margin-top:var(--space-1)}

    /* Responsive */
    @media (max-width:768px){
      .container{padding:var(--space-2)}
      .stats-grid{grid-template-columns:1fr}
      .header h1{font-size:var(--font-size-xl)}
      .header .info{font-size:var(--font-size-xs)}
      .stat-card{padding:var(--space-2)}
      .stat-icon{width:32px;height:32px;font-size:.85rem}
      .stat-content .stat-number{font-size:var(--font-size-base)}
      th,td{padding:var(--space-2) var(--space-1);font-size:var(--font-size-xs)}
      .class-badge,.status-badge,.avg-badge{padding:var(--space-1);font-size:var(--font-size-xs)}
    }
    @media (max-width:480px){
      .header .back-btn{padding:var(--space-1) var(--space-2);font-size:var(--font-size-xs)}
      .title i{font-size:var(--font-size-base)}
      .header h1{font-size:var(--font-size-lg)}
    }

    /* Row tint */
    tr.kelas-8A{background:rgba(35,70,38,.05)}
    tr.kelas-9A{background:rgba(212,175,55,.05)}
    tr.kelas-9B{background:rgba(22,163,74,.05)}
    tr.kelas-9C{background:rgba(37,99,235,.05)}
    tr.kelas-9D{background:rgba(107,114,128,.05)}
    tr.kelas-5-Kelas{background:var(--footer-bg);font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="back-nav">
        <a href="../index.html" class="back-btn">
          <i class="fas fa-arrow-left"></i><span>Back to Dashboard</span>
        </a>
      </div>
      <div class="title">
        <i class="fas fa-chart-line"></i>
        <h1>Class Progress</h1>
      </div>
      <div class="info">
        <span><strong>Guru:</strong> Ahmad Zaman Huri, S.Pd.</span>
        <span><strong>Sekolah:</strong> MTsT Daarut Tahfizh Al-Ikhlas</span>
        <span><strong>Pelajaran:</strong> Bahasa Inggris</span>
      </div>
    </header>

    <!-- Statistics Cards -->
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-school"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="totalClasses">-</div>
            <div class="stat-label">Total Classes</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="totalStudents">-</div>
            <div class="stat-label">Total Students</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="lastUpdate">-</div>
            <div class="stat-label">Last Update</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Data Table -->
    <section class="data-section">
      <div class="table-container">
        <table id="progressTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Class</th>
              <th>Total Students</th>
              <th>Avg PTS</th>
              <th>Avg UAS</th>
              <th>Avg Daily</th>
              <th>PTS Need Remedial</th>
              <th>PTS Passed</th>
              <th>UAS Need Remedial</th>
              <th>UAS Passed</th>
              <th>Progress Status</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="11" class="loading-cell">
              <div class="loading-spinner"></div>
              Memuat data...
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="brand">English Progress System</div>
      <div class="info">Developed by Ahmad Zaman Huri, S.Pd.</div>
    </footer>
  </div>

  <!-- ===== JAVASCRIPT (TIDAK DIUBAH) ===== -->
  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1N-docAeezSqzkQcTk8mcPm-qMf-EisMELs_N35zAaT8/gviz/tq?tqx=out:csv&sheet=%F0%9F%93%88%20class_progress";
    const tableBody = document.getElementById("tableBody");
    const totalClasses = document.getElementById("totalClasses");
    const totalStudents = document.getElementById("totalStudents");
    const lastUpdate = document.getElementById("lastUpdate");
    let allData = [];

    function parseCSV(csvText) {
      const rows = [];
      let currentRow = [];
      let inQuotes = false;
      let currentValue = "";
      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i + 1];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          currentRow.push(currentValue.trim());
          currentValue = "";
        } else if (char === '\n' && !inQuotes) {
          currentRow.push(currentValue.trim());
          rows.push(currentRow);
          currentRow = [];
          currentValue = "";
        } else if (char === '\r' && nextChar === '\n' && !inQuotes) {
          currentRow.push(currentValue.trim());
          rows.push(currentRow);
          currentRow = [];
          currentValue = "";
          i++;
        } else {
          currentValue += char;
        }
      }
      if (currentValue.trim() !== "" || currentRow.length > 0) {
        currentRow.push(currentValue.trim());
        rows.push(currentRow);
      }
      return rows;
    }

    function getStatusClass(status) {
      switch (status) {
        case 'üü¢ EXCELLENT': return 'status-excellent';
        case 'üü° GOOD': return 'status-good';
        case 'üü† NEEDS IMPROVEMENT': return 'status-needs-improvement';
        case 'üî¥ CRITICAL': return 'status-critical';
        case '‚è≥ WAITING DATA': return 'status-waiting';
        case '‚è≥ DATA BELUM LENGKAP': return 'status-waiting';
        default: return '';
      }
    }

    function formatAverage(value) {
      if (value === 'NO DATA' || value === 'WAITING DATA') {
        return `<span class="avg-badge avg-no-data">${value}</span>`;
      }
      const num = parseFloat(value);
      if (isNaN(num)) return `<span class="avg-badge avg-no-data">${value}</span>`;
      let className = '';
      if (num < 75) className = 'avg-warning';
      else if (num <= 79) className = 'avg-standard';
      else className = 'avg-good';
      return `<span class="avg-badge ${className}">${num.toFixed(2)}</span>`;
    }

    async function loadData() {
      try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        if (rows.length < 2) throw new Error("No data rows found");

        allData = rows.slice(1)
          .filter(r => r.length >= 11 && r[1] && r[1].trim() !== "")
          .map(row => ({
            no: row[0].replace(/^"|"$/g, ""),
            class: row[1].replace(/^"|"$/g, ""),
            totalStudents: row[2].replace(/^"|"$/g, ""),
            avgPTS: row[3].replace(/^"|"$/g, ""),
            avgUAS: row[4].replace(/^"|"$/g, ""),
            avgDaily: row[5].replace(/^"|"$/g, ""),
            ptsNeedRemedial: row[6].replace(/^"|"$/g, ""),
            ptsPassed: row[7].replace(/^"|"$/g, ""),
            uasNeedRemedial: row[8].replace(/^"|"$/g, ""),
            uasPassed: row[9].replace(/^"|"$/g, ""),
            progressStatus: row[10].replace(/^"|"$/g, "")
          }));

        renderTable(allData);
        updateStatistics(allData);
        updateLastUpdate();
      } catch (e) {
        console.error("Error loading data:", e);
        tableBody.innerHTML = `<tr><td colspan="11" class="error-cell"><i class="fas fa-exclamation-circle"></i>Gagal memuat data: ${e.message}. Pastikan sheet dipublikasikan.</td></tr>`;
      }
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="11" class="no-data">Tidak ada data</td></tr>`;
        return;
      }
      const regularRows = data.filter(item => !item.class.includes('Kelas'));
      const footerRow = data.find(item => item.class.includes('Kelas'));

      regularRows.forEach(item => {
        const tr = document.createElement("tr");
        tr.classList.add(`kelas-${item.class.replace(/\W/g, '')}`);
        tr.innerHTML = `
          <td>${item.no || '-'}</td>
          <td><span class="class-badge">${item.class || '-'}</span></td>
          <td>${item.totalStudents || '-'}</td>
          <td>${formatAverage(item.avgPTS)}</td>
          <td>${formatAverage(item.avgUAS)}</td>
          <td>${formatAverage(item.avgDaily)}</td>
          <td>${item.ptsNeedRemedial || '-'}</td>
          <td>${item.ptsPassed || '-'}</td>
          <td>${item.uasNeedRemedial || '-'}</td>
          <td>${item.uasPassed || '-'}</td>
          <td><span class="status-badge ${getStatusClass(item.progressStatus)}">${item.progressStatus || '-'}</span></td>
        `;
        tableBody.appendChild(tr);
      });

      if (footerRow) {
        const tr = document.createElement("tr");
        tr.classList.add('total-row', `kelas-${footerRow.class.replace(/\W/g, '')}`);
        tr.innerHTML = `
          <td>${footerRow.no || '-'}</td>
          <td><span class="class-badge">${footerRow.class || '-'}</span></td>
          <td>${footerRow.totalStudents || '-'}</td>
          <td>${formatAverage(footerRow.avgPTS)}</td>
          <td>${formatAverage(footerRow.avgUAS)}</td>
          <td>${formatAverage(footerRow.avgDaily)}</td>
          <td>${footerRow.ptsNeedRemedial || '-'}</td>
          <td>${footerRow.ptsPassed || '-'}</td>
          <td>${footerRow.uasNeedRemedial || '-'}</td>
          <td>${footerRow.uasPassed || '-'}</td>
          <td><span class="status-badge ${getStatusClass(footerRow.progressStatus)}">${footerRow.progressStatus || '-'}</span></td>
        `;
        tableBody.appendChild(tr);
      }
    }

    function updateStatistics(data) {
      const classes = data.filter(item => item.no && item.class && !item.class.includes('Kelas'));
      totalClasses.textContent = classes.length;
      const footerRow = data.find(item => item.class.includes('Kelas'));
      totalStudents.textContent = footerRow ? footerRow.totalStudents : classes.reduce((sum, item) => sum + parseInt(item.totalStudents || 0), 0);
    }

    function updateLastUpdate() {
      const now = new Date();
      lastUpdate.textContent = now.toLocaleString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    loadData();
  </script>
</body>
</html>
