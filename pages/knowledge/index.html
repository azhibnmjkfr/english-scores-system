<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Knowledge Scores - MTsT Daarut Tahfizh Al-Ikhlas</title>
  <meta name="description" content="Personal Knowledge Scores Analysis - English Language">
  <meta name="author" content="Ahmad Zaman Huri, S.Pd.">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      /* Color Palette */
      --primary:#234626; --primary-dark:#1A351D; --accent-gold:#D4AF37;
      --neutral-white:#FFFFFF; --neutral-light:#F9FAFB; --neutral-gray:#E5E7EB; --neutral-dark:#374151;
      --success:#16A34A; --warning:#F59E0B; --danger:#DC2626; --text-dark:#111827;
      --border-success:#14532D; --border-warning:#9A3412; --border-danger:#991B1B; --border-class:#0D1F11;

      /* Extra for this page */
      --bab13-bg: rgba(30,58,138,.05); /* Biru tipis BAB 1 & 3 */
      --pts-rph-bg: rgba(22,163,74,.1); /* Hijau tipis PTS & RPH */

      /* Typography */
      --font-family:'Inter',system-ui,sans-serif;
      --font-size-xs:.75rem; --font-size-sm:.875rem; --font-size-base:1rem; --font-size-lg:1.0625rem; --font-size-xl:1.25rem; --font-size-2xl:1.35rem;

      /* Spacing (dirapatkan) */
      --space-1:.25rem; --space-2:.5rem; --space-3:.65rem; --space-4:.85rem; --space-6:1.1rem;

      /* Radius */
      --radius-sm:.35rem; --radius-md:.5rem; --radius-lg:1rem;

      /* Shadows (ringan) */
      --shadow-sm:0 1px 2px rgba(0,0,0,.04);
      --shadow-md:0 2px 6px rgba(0,0,0,.08);
      --shadow-badge:0 1px 1px rgba(0,0,0,.06);

      /* Transition */
      --transition:all .2s ease;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:var(--font-family);
      background:var(--neutral-light);
      color:var(--neutral-dark);
      min-height:100vh; line-height:1.5; -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1100px;margin:0 auto;padding:var(--space-2) var(--space-3)}

    /* Header (dirapatkan & diseragamkan) */
    .header{
      background:var(--primary);color:#fff;
      padding:var(--space-4); text-align:center; border-bottom:3px solid var(--accent-gold);
      border-radius:0 0 var(--radius-md) var(--radius-md);
    }
    .header .back-nav{ text-align:left; margin-bottom:var(--space-2) }
    .back-btn{
      display:inline-flex;align-items:center;gap:var(--space-2);
      color:#fff; text-decoration:none; font-weight:600;
      font-size:var(--font-size-xs); padding:var(--space-1) var(--space-2);
      border-radius:var(--radius-sm); background:var(--primary-dark);
      border:1px solid rgba(255,255,255,.1);
    }
    .back-btn:hover{ background:var(--accent-gold); color:var(--primary) }

    .title{display:flex;align-items:center;justify-content:center;gap:var(--space-2)}
    .title i{font-size:var(--font-size-xl)}
    .header h1{font-size:var(--font-size-2xl);font-weight:700;margin:0}
    .header .info{font-size:var(--font-size-xs);opacity:.95;max-width:700px;margin:var(--space-2) auto 0}
    .header .info span{display:inline-block;margin:0 var(--space-2)}

    /* Stats (dirapatkan) */
    .stats-section{padding:var(--space-3) 0}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:var(--space-3)}
    .stat-card{
      background:#fff;border-radius:var(--radius-md);box-shadow:var(--shadow-sm);
      padding:var(--space-3);display:flex;align-items:center;gap:var(--space-2);border:1px solid #F1F5F9;
    }
    .stat-icon{
      width:36px;height:36px;background:var(--primary);border-radius:.5rem;
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:.95rem;
    }
    .stat-content .stat-number{font-size:var(--font-size-lg);font-weight:700;color:var(--primary)}
    .stat-content .stat-label{font-size:var(--font-size-xs);opacity:.9}

    /* Filters (dirapatkan) */
    .filters-section{
      padding:var(--space-3); background:#fff; border-radius:var(--radius-md);
      margin:var(--space-3) 0; box-shadow:var(--shadow-sm); border:1px solid #F1F5F9;
    }
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:var(--space-2);align-items:center}
    .filter-select,.filter-btn{
      padding:var(--space-2) var(--space-2); border:1px solid var(--neutral-gray);
      border-radius:var(--radius-sm); font-size:var(--font-size-sm); background:#fff; transition:var(--transition)
    }
    .filter-select:focus{outline:none;border-color:var(--primary)}
    .filter-btn{
      background:var(--primary);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;gap:var(--space-2);font-weight:600
    }
    .filter-btn:hover{background:var(--primary-dark)}

    /* Table (rapat) */
    .data-section{padding:var(--space-2) 0; overflow-x:auto}
    .table-container{background:#fff;border-radius:var(--radius-md);box-shadow:var(--shadow-md);border:1px solid #EEF2F7}
    table{width:100%;border-collapse:collapse;min-width:1000px}
    thead{background:var(--primary);color:#fff;position:sticky;top:0;z-index:1}
    th{padding:var(--space-3);font-weight:700;font-size:var(--font-size-sm);text-align:center}
    .merged-header{border-bottom:1px solid rgba(255,255,255,.9)}
    .sub-header th{font-size:var(--font-size-xs);padding:var(--space-2) var(--space-1);width:60px}
    td{padding:var(--space-2) var(--space-1);border-bottom:1px solid var(--neutral-gray);font-size:var(--font-size-sm);text-align:center}
    tbody tr:last-child td{border-bottom:none}

    /* Penanda kolom & hover */
    .pts,.rph{background:var(--pts-rph-bg);width:80px}
    tbody tr:hover{background:rgba(35,70,38,.1);transition:var(--transition)}

    /* BAB 1 & 3 */
    .bab13{background:var(--bab13-bg)}

    /* Badges */
    .class-badge,.grade-badge{
      padding:var(--space-1) var(--space-2); border-radius:var(--radius-lg);
      font-size:var(--font-size-xs); font-weight:600; display:inline-block; text-align:center; box-shadow:var(--shadow-badge)
    }
    .class-badge{background:var(--primary-dark);color:#fff;min-width:50px;border:1px solid var(--border-class)}
    .grade-badge{min-width:40px;border:1px solid}
    .grade-passed{background:var(--success);color:#fff;border-color:var(--border-success)}
    .grade-warning{background:var(--warning);color:var(--text-dark);border-color:var(--border-warning)}
    .grade-failed{background:var(--danger);color:#fff;border-color:var(--border-danger)}

    /* States */
    .loading-cell{text-align:center;padding:var(--space-6);color:var(--neutral-dark)}
    .loading-spinner{width:22px;height:22px;border:3px solid var(--neutral-gray);border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto var(--space-2)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-cell{text-align:center;padding:var(--space-6);color:var(--danger)}
    .error-cell i{font-size:var(--font-size-base);margin-bottom:var(--space-2);display:block}
    .no-data{text-align:center;padding:var(--space-6);color:var(--neutral-dark)}

    /* Footer (ringkas) */
    .footer{
      background:var(--primary-dark);color:#fff;text-align:center;
      padding:var(--space-3);margin-top:var(--space-3);border-radius:var(--radius-md);font-size:var(--font-size-xs)
    }
    .footer .brand{font-size:var(--font-size-sm);font-weight:700}
    .footer .info{opacity:.9;margin-top:var(--space-1)}

    /* Responsive */
    @media (max-width:768px){
      .container{padding:var(--space-2)}
      .filters-grid,.stats-grid{grid-template-columns:1fr}
      .header h1{font-size:var(--font-size-xl)}
      .header .info{font-size:var(--font-size-xs)}
      .stat-card{padding:var(--space-2)}
      .stat-icon{width:32px;height:32px;font-size:.85rem}
      .stat-content .stat-number{font-size:var(--font-size-base)}
      th,td{padding:var(--space-2) var(--space-1);font-size:var(--font-size-xs)}
      .class-badge,.grade-badge{padding:var(--space-1) var(--space-2)}
      .sub-header th{width:50px}
      .pts,.rph{width:70px}
    }
    @media (max-width:480px){
      .back-btn{padding:var(--space-1) var(--space-2);font-size:var(--font-size-xs)}
      .title i{font-size:var(--font-size-base)}
      .header h1{font-size:var(--font-size-lg)}
    }

    /* Class-specific row tint */
    tr.kelas-8A{background:rgba(35,70,38,.04)}
    tr.kelas-8B{background:rgba(212,175,55,.05)}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="back-nav">
        <!-- Pakai ABSOLUTE URL seperti halaman lain -->
        <a href="https://azhibnmjkfr.github.io/english-scores-system/" class="back-btn">
          <i class="fas fa-arrow-left"></i><span>Back to Dashboard</span>
        </a>
      </div>
      <div class="title">
        <i class="fas fa-book"></i>
        <h1>Personal Knowledge Scores</h1>
      </div>
      <div class="info">
        <span><strong>Guru:</strong> Ahmad Zaman Huri, S.Pd.</span>
        <span><strong>Sekolah:</strong> MTsT Daarut Tahfizh Al-Ikhlas</span>
        <span><strong>Pelajaran:</strong> Bahasa Inggris</span>
      </div>
    </header>

    <!-- Statistics Cards -->
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="totalStudents">-</div>
            <div class="stat-label">Total Students</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="averageScore">-</div>
            <div class="stat-label">Average PTS</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-trophy"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="highestScore">-</div>
            <div class="stat-label">Highest PTS</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-content">
            <div class="stat-number" id="lastUpdate">-</div>
            <div class="stat-label">Last Update</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section class="filters-section">
      <div class="filters-grid">
        <select id="filterClass" class="filter-select">
          <option value="">Semua Kelas</option>
        </select>
        <select id="filterPts" class="filter-select">
          <option value="">Semua PTS</option>
          <option value="top10">Top 10 PTS</option>
          <option value="top20">Top 20 PTS</option>
        </select>
        <select id="filterRph" class="filter-select">
          <option value="">Semua RPH</option>
          <option value="top10">Top 10 RPH</option>
          <option value="top20">Top 20 RPH</option>
        </select>
        <button id="resetFilters" class="filter-btn">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </section>

    <!-- Data Table -->
    <section class="data-section">
      <div class="table-container">
        <table id="nilaiTable">
          <thead>
            <tr class="merged-header">
              <th rowspan="2">No</th>
              <th rowspan="2">Student Code</th>
              <th rowspan="2">Student Name</th>
              <th rowspan="2">Class</th>
              <th colspan="3">Bab 1</th>
              <th colspan="3">Bab 2</th>
              <th colspan="3">Bab 3</th>
              <th colspan="3">Bab 4</th>
              <th rowspan="2">PTS</th>
              <th rowspan="2">RPH</th>
            </tr>
            <tr class="sub-header">
              <th class="bab13">TSK</th><th class="bab13">RES</th><th class="bab13">EVA</th>
              <th>TSK</th><th>RES</th><th>EVA</th>
              <th class="bab13">TSK</th><th class="bab13">RES</th><th class="bab13">EVA</th>
              <th>TSK</th><th>RES</th><th>EVA</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="17" class="loading-cell">
              <div class="loading-spinner"></div>
              Memuat data...
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="brand">English Scores System</div>
      <div class="info">Developed by Ahmad Zaman Huri, S.Pd.</div>
    </footer>
  </div>

  <!-- === SCRIPT: Tidak disentuh selain tetap utuh sesuai aslinya === -->
  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1N-docAeezSqzkQcTk8mcPm-qMf-EisMELs_N35zAaT8/gviz/tq?tqx=out:csv&sheet=%F0%9F%93%9A%20personal_knowledge";
    const filterClass = document.getElementById("filterClass");
    const filterPts = document.getElementById("filterPts");
    const filterRph = document.getElementById("filterRph");
    const resetBtn = document.getElementById("resetFilters");
    const tableBody = document.getElementById("tableBody");
    const totalStudents = document.getElementById("totalStudents");
    const averageScore = document.getElementById("averageScore");
    const highestScore = document.getElementById("highestScore");
    const lastUpdate = document.getElementById("lastUpdate");
    let allData = [];

    function parseCSV(csvText) {
      const rows = [];
      let currentRow = [];
      let inQuotes = false;
      let currentValue = "";
      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i + 1];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          currentRow.push(currentValue.trim());
          currentValue = "";
        } else if (char === '\n' && !inQuotes) {
          currentRow.push(currentValue.trim());
          rows.push(currentRow);
          currentRow = [];
          currentValue = "";
        } else if (char === '\r' && nextChar === '\n' && !inQuotes) {
          currentRow.push(currentValue.trim());
          rows.push(currentRow);
          currentRow = [];
          currentValue = "";
          i++;
        } else {
          currentValue += char;
        }
      }
      if (currentValue.trim() !== "" || currentRow.length > 0) {
        currentRow.push(currentValue.trim());
        rows.push(currentRow);
      }
      return rows;
    }

    async function loadData() {
      try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        if (rows.length < 2) throw new Error("No data rows found");

        allData = rows.slice(1)
          .filter(r => r.length >= 17 && r[1] && r[1].trim() !== "")
          .map(row => ({
            no: row[0].replace(/^"|"$/g, ""),
            studentCode: row[1].replace(/^"|"$/g, ""),
            studentName: row[2].replace(/^"|"$/g, ""),
            class: row[3].replace(/^"|"$/g, ""),
            bab1Tsk: row[4].replace(/^"|"$/g, ""),
            bab1Res: row[5].replace(/^"|"$/g, ""),
            bab1Eva: row[6].replace(/^"|"$/g, ""),
            bab2Tsk: row[7].replace(/^"|"$/g, ""),
            bab2Res: row[8].replace(/^"|"$/g, ""),
            bab2Eva: row[9].replace(/^"|"$/g, ""),
            bab3Tsk: row[10].replace(/^"|"$/g, ""),
            bab3Res: row[11].replace(/^"|"$/g, ""),
            bab3Eva: row[12].replace(/^"|"$/g, ""),
            bab4Tsk: row[13].replace(/^"|"$/g, ""),
            bab4Res: row[14].replace(/^"|"$/g, ""),
            bab4Eva: row[15].replace(/^"|"$/g, ""),
            pts: row[16].replace(/^"|"$/g, ""),
            rph: row[17] ? row[17].replace(/^"|"$/g, "") : "-"
          }));

        renderTable(allData);
        fillDropdowns(allData);
        updateStatistics(allData);
        updateLastUpdate();
      } catch (e) {
        console.error("Error loading data:", e);
        tableBody.innerHTML = `<tr><td colspan="17" class="error-cell"><i class="fas fa-exclamation-circle"></i>Gagal memuat data: ${e.message}. Pastikan sheet dipublikasikan.</td></tr>`;
      }
    }

    function getGradeClass(score) {
      const numScore = parseFloat(score);
      if (isNaN(numScore)) return "";
      if (numScore >= 80) return "grade-passed";
      if (numScore >= 75) return "grade-warning";
      return "grade-failed";
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="17" class="no-data">Tidak ada data</td></tr>`;
        return;
      }
      data.forEach(item => {
        const tr = document.createElement("tr");
        tr.classList.add(`kelas-${item.class.replace(/\W/g, '')}`);
        tr.innerHTML = `
          <td>${item.no || '-'}</td>
          <td>${item.studentCode || '-'}</td>
          <td>${item.studentName || '-'}</td>
          <td><span class="class-badge">${item.class || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab1Tsk)}">${item.bab1Tsk || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab1Res)}">${item.bab1Res || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab1Eva)}">${item.bab1Eva || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab2Tsk)}">${item.bab2Tsk || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab2Res)}">${item.bab2Res || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab2Eva)}">${item.bab2Eva || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab3Tsk)}">${item.bab3Tsk || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab3Res)}">${item.bab3Res || '-'}</span></td>
          <td class="bab13"><span class="grade-badge ${getGradeClass(item.bab3Eva)}">${item.bab3Eva || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab4Tsk)}">${item.bab4Tsk || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab4Res)}">${item.bab4Res || '-'}</span></td>
          <td><span class="grade-badge ${getGradeClass(item.bab4Eva)}">${item.bab4Eva || '-'}</span></td>
          <td class="pts"><span class="grade-badge ${getGradeClass(item.pts)}">${item.pts || '-'}</span></td>
          <td class="rph"><span class="grade-badge ${getGradeClass(item.rph)}">${item.rph || '-'}</span></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function fillDropdowns(data) {
      const classSet = new Set(data.map(item => item.class).filter(c => c));
      filterClass.innerHTML = '<option value="">Semua Kelas</option>';
      Array.from(classSet).sort().forEach(item => {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = item;
        filterClass.appendChild(option);
      });
    }

    function updateStatistics(data) {
      const ptsScores = data
        .map(item => parseFloat(item.pts))
        .filter(score => !isNaN(score) && score > 0);
      totalStudents.textContent = data.length;
      averageScore.textContent = ptsScores.length > 0 ? (ptsScores.reduce((a, b) => a + b, 0) / ptsScores.length).toFixed(1) : '0.0';
      highestScore.textContent = ptsScores.length > 0 ? Math.max(...ptsScores).toFixed(1) : '0.0';
    }

    function updateLastUpdate() {
      const now = new Date();
      lastUpdate.textContent = now.toLocaleString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function filterTable() {
      let filtered = [...allData];

      // Filter Kelas
      const classVal = filterClass.value.toLowerCase();
      if (classVal) {
        filtered = filtered.filter(item => item.class.toLowerCase() === classVal);
      }

      // Filter Highest PTS
      const ptsVal = filterPts.value;
      if (ptsVal) {
        filtered = filtered
          .filter(item => parseFloat(item.pts) > 0)
          .sort((a, b) => parseFloat(b.pts) - parseFloat(a.pts))
          .slice(0, ptsVal === "top10" ? 10 : 20);
      }

      // Filter Highest RPH
      const rphVal = filterRph.value;
      if (rphVal) {
        filtered = filtered
          .filter(item => parseFloat(item.rph) > 0)
          .sort((a, b) => parseFloat(b.rph) - parseFloat(a.rph))
          .slice(0, rphVal === "top10" ? 10 : 20);
      }

      renderTable(filtered);
      updateStatistics(filtered);
    }

    filterClass.addEventListener("change", filterTable);
    filterPts.addEventListener("change", filterTable);
    filterRph.addEventListener("change", filterTable);
    resetBtn.addEventListener("click", () => {
      filterClass.value = "";
      filterPts.value = "";
      filterRph.value = "";
      renderTable(allData);
      updateStatistics(allData);
    });

    loadData();
  </script>
</body>
</html>
